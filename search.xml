<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>K8S 中使用 Prometheus 监控 JVM</title>
      <link href="posts/k8s-prometheus-monitor-jvm/"/>
      <url>posts/k8s-prometheus-monitor-jvm/</url>
      
        <content type="html"><![CDATA[<h2 id="操作场景"><a href="#操作场景" class="headerlink" title="操作场景"></a>操作场景</h2><p>Prometheus 社区开发了 JMX Exporter 用于导出 JVM 的监控指标，以便使用 Prometheus 来采集监控数据。当您的 Java 业务容器化至 Kubernetes 后，可通过本文了解如何使用 Prometheus 与 JMX Exporter 来监控 Java 应用。</p><p>&nbsp;</p><h2 id="JMX-Exporter-简介"><a href="#JMX-Exporter-简介" class="headerlink" title="JMX Exporter 简介"></a>JMX Exporter 简介</h2><p>Java Management Extensions，JMX 是管理 Java 的一种扩展框架，JMX Exporter 基于此框架读取 JVM 的运行时状态。JMX Exporter 利用 Java 的 JMX 机制来读取 JVM 运行时的监控数据，然后将其转换为 Prometheus 可辨识的 metrics 格式，以便让 Prometheus 对其进行监控采集。</p><p>JMX Exporter 提供<strong>启动独立进程</strong>及 <strong>JVM 进程内启动（in-process）</strong>两种方式暴露 JVM 监控指标：</p><ol><li><strong>启动独立进程</strong><br>JVM 启动时指定参数，暴露 JMX 的 RMI 接口。JMX Exporter 调用 RMI 获取 JVM 运行时状态数据，转换为 Prometheus metrics 格式，并暴露端口让 Prometheus 采集。</li><li><strong>JVM 进程内启动（in-process）</strong><br>JVM 启动时指定参数，通过 javaagent 的形式运行 JMX Exporter 的 jar 包，进程内读取 JVM 运行时状态数据，转换为 Prometheus metrics 格式，并暴露端口让 Prometheus 采集。</li></ol><blockquote><p>说明：</p><p>官方不建议使用<strong>启动独立进程</strong>方式，该方式配置复杂且需单独的进程，进程本身的监控又引发了新的问题。本文以 <strong>JVM 进程内启动（in-process）</strong>方式为例，在 Kubernetes 环境下使用 JMX Exporter 暴露 JVM 监控指标。</p></blockquote><p>&nbsp;</p><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><h3 id="使用-JMX-Exporter-暴露-JVM-监控指标"><a href="#使用-JMX-Exporter-暴露-JVM-监控指标" class="headerlink" title="使用 JMX Exporter 暴露 JVM 监控指标"></a>使用 JMX Exporter 暴露 JVM 监控指标</h3><p>使用 JVM 进程内启动（in-process）方式，启动 JVM 需指定 JMX Exporter 的 jar 包文件和配置文件。jar 包为二进制文件，不便通过 <code>ConfigMap</code> 挂载，建议直接将 JMX Exporter 的 jar 包和配置文件都打包到业务容器镜像中。</p><p>这里为了方便演示，jar 包就简单用 <code>hostPath</code> 的方式直接挂载进容器里，配置文件使用 <code>ConfigMap</code> 的形式挂载到容器里。</p><h4 id="准备jar包和配置文件"><a href="#准备jar包和配置文件" class="headerlink" title="准备jar包和配置文件"></a>准备jar包和配置文件</h4><ol><li><p>准备 jar 包文件，可前往 <a href="https://github.com/prometheus/jmx_exporter">jmx_exporter</a> 的 Github 页面获取最新的 jar 包下载地址。执行以下命令，下载到挂载指定的 <code>hostPath</code> 目录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /data/prometheus/jmx_exporter</span><br><span class="line">$ wget -O /data/prometheus/jmx_exporter/jmx_prometheus_javaagent-0.15.0.jar https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.15.0/jmx_prometheus_javaagent-0.15.0.jar</span><br></pre></td></tr></table></figure></li><li><p>编写 JMX Exporter 配置文件 <code>prometheus-jmx-config.yaml</code> 。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-jmx-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus-jmx-config.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    lowercaseOutputLabelNames: true</span></span><br><span class="line"><span class="string">    lowercaseOutputName: true</span></span><br><span class="line"><span class="string">    whitelistObjectNames: [&quot;java.lang:type=OperatingSystem&quot;]</span></span><br><span class="line"><span class="string">    blacklistObjectNames: []</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">      - pattern: &#x27;java.lang&lt;type=OperatingSystem&gt;&lt;&gt;(committed_virtual_memory|free_physical_memory|free_swap_space|total_physical_memory|total_swap_space)_size:&#x27;</span></span><br><span class="line"><span class="string">        name: os_$1_bytes</span></span><br><span class="line"><span class="string">        labels: &#123;&#125;</span></span><br><span class="line"><span class="string">        type: GAUGE</span></span><br><span class="line"><span class="string">        attrNameSnakeCase: true</span></span><br><span class="line"><span class="string">      - pattern: &#x27;java.lang&lt;type=OperatingSystem&gt;&lt;&gt;((?!process_cpu_time)\w+):&#x27;</span></span><br><span class="line"><span class="string">        name: os_$1</span></span><br><span class="line"><span class="string">        labels: &#123;&#125;</span></span><br><span class="line"><span class="string">        type: GAUGE</span></span><br><span class="line"><span class="string">        attrNameSnakeCase: true</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：</p><p>更多配置项请参考 <a href="https://prometheus.io/docs/introduction/overview/">Prometheus</a> 官方文档。</p></blockquote></li></ol><h4 id="部署-Java-应用"><a href="#部署-Java-应用" class="headerlink" title="部署 Java 应用"></a>部署 Java 应用</h4><p>部署应用至 Kubernetes 时，需修改 JVM 启动参数以便启动时加载 JMX Exporter。JVM 启动时会读取 <code>JAVA_OPTS</code> 环境变量，作为额外的启动参数，部署时可为应用增加该环境变量。</p><ul><li>启动参数格式： <code>-javaagent:&lt;jar&gt;=&lt;port&gt;:&lt;config&gt;</code></li><li>该示例使用8088端口暴露 JVM 的监控指标，您可按需自行更改。</li></ul><p>下面以Tomcat为示例：</p><ol><li><p>编写tomcat的<code>Deployment</code>文件。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">tomcat:jdk8-openjdk-slim</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;-javaagent:/jmx_prometheus_javaagent-0.15.0.jar=8088:/jmx/prometheus-jmx-config.yaml&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/jmx_prometheus_javaagent-0.15.0.jar&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">jmx-prometheus-javaagent</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/jmx&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-jmx-config</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jmx-prometheus-javaagent</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/data/prometheus/jmx_exporter/jmx_prometheus_javaagent-0.15.0.jar</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span> </span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-jmx-config</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">prometheus-jmx-config</span></span><br></pre></td></tr></table></figure></li><li><p>编写tomcat的 <code>Service</code> 文件。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&quot;8088&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/jvm:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jmx-metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8088</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>注意</strong>：</p><p>在 Service 中添加的 <code>annotations</code> 字段，作用是为了在 Promethues 配置文件的 <code>RawJobs</code> 中对标签做一些重新标记配置等。</p></blockquote></li></ol><p>&nbsp;</p><h3 id="添加-Prometheus-监控配置"><a href="#添加-Prometheus-监控配置" class="headerlink" title="添加 Prometheus 监控配置"></a>添加 Prometheus 监控配置</h3><p>配置 Prometheus，使监控数据可被采集。示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">jvm</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_jvm</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">application</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br></pre></td></tr></table></figure><p>&nbsp;</p><h3 id="添加-Grafana-监控面板"><a href="#添加-Grafana-监控面板" class="headerlink" title="添加 Grafana 监控面板"></a>添加 Grafana 监控面板</h3><p>采集数据后可进行数据展示。若熟悉 Prometheus 和 Grafana，则可自行根据指标设计所需面板。您也可直接使用社区提供面板，例如 <a href="https://grafana.com/grafana/dashboards/8563">JVM dashboard</a>。可直接导入使用。</p><p>不过上面这个Dashboard，有一些地方使用起来不太友好，所以在其基础上进行了一些修改。</p><p><a href="https://download.wanhebin.com/package/grafana/dashboard/Grafana-Dashboard-JVM-Prometheus_Jmx_Exporter.json">模板下载链接</a>，下载后直接把文件的json内容复制导入Grafana，面板效果图如下：</p><p><img src="https://pic-cdn.wanhebin.com/2021/05/22/e7a76427de828.png" alt="prometheus-grafana-jmx_exporter.png"></p><blockquote><p><strong>注意</strong>：</p><p>由于这个Dashboard是根据 Promethues 中 RawJobs 定制的，若要使用这个Dashboard，Prometheus 中的 RawJobs 规则需要与文中一致，建议不要修改。否则可能会出现某些功能不生效的情况。（当然，如果你熟悉Promethues，也可以根据自己需求进行调整）</p></blockquote><p>&nbsp;</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://github.com/prometheus/jmx_exporter">JMX Exporter 项目地址</a></li><li><a href="https://grafana.com/grafana/dashboards/8563">JVM 监控面板</a></li><li><a href="https://cloud.tencent.com/document/product/457/48724">使用 Prometheus 监控 Java 应用</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS 7 定制 OpenSSL  RPM包</title>
      <link href="posts/centos7-custom-openssl-rpm-package/"/>
      <url>posts/centos7-custom-openssl-rpm-package/</url>
      
        <content type="html"><![CDATA[<h2 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h2><h4 id="1-1-安装RPM打包、测试必备开发工具"><a href="#1-1-安装RPM打包、测试必备开发工具" class="headerlink" title="1.1 安装RPM打包、测试必备开发工具"></a>1.1 安装RPM打包、测试必备开发工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y rpm-build rpmlint rpmdevtools</span><br></pre></td></tr></table></figure><h4 id="1-2-安装打包、编译所需的依赖软件"><a href="#1-2-安装打包、编译所需的依赖软件" class="headerlink" title="1.2 安装打包、编译所需的依赖软件"></a>1.2 安装打包、编译所需的依赖软件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y gcc gcc-c++ make perl perl-WWW-Curl</span><br></pre></td></tr></table></figure><h2 id="二、制作-OpenSSL-的-RPM-包"><a href="#二、制作-OpenSSL-的-RPM-包" class="headerlink" title="二、制作 OpenSSL 的 RPM 包"></a>二、制作 OpenSSL 的 RPM 包</h2><blockquote><p><strong>注意：</strong></p><p>切记！不要使用 <code>root</code> 用户来执行打包操作。因为这十分危险，所有二进制文件都会在打包前安装至系统中，因此您应该以普通用户身份打包，以防止系统被破坏。</p></blockquote><h4 id="2-1-配置-rpmbuild-工作目录"><a href="#2-1-配置-rpmbuild-工作目录" class="headerlink" title="2.1 配置 rpmbuild 工作目录"></a>2.1 配置 rpmbuild 工作目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/rpmbuild/&#123;BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS&#125;</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;%_topdir %&#123;getenv:HOME&#125;/rpmbuild&quot;</span> &gt; ~/.rpmmacros</span><br></pre></td></tr></table></figure><h4 id="2-2-下载源码包到-rpmbuild-SOURCES-目录"><a href="#2-2-下载源码包到-rpmbuild-SOURCES-目录" class="headerlink" title="2.2 下载源码包到 ~/rpmbuild/SOURCES 目录"></a>2.2 下载源码包到 <code>~/rpmbuild/SOURCES</code> 目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O ~/rpmbuild/SOURCES/openssl-1.1.1k.tar.gz https://www.openssl.org/<span class="built_in">source</span>/openssl-1.1.1k.tar.gz</span><br></pre></td></tr></table></figure><h4 id="2-3-编写-openssl-1-1-1k-软件库包的spec文件"><a href="#2-3-编写-openssl-1-1-1k-软件库包的spec文件" class="headerlink" title="2.3 编写 openssl 1.1.1k 软件库包的spec文件"></a>2.3 编写 <code>openssl 1.1.1k</code> 软件库包的spec文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~/rpmbuild/SPECS/openssl.spec</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Name:openssl</span><br><span class="line">Version:1.1.1k</span><br><span class="line">Release:1%&#123;?dist&#125;</span><br><span class="line">Summary:Utilities from the general purpose cryptography library with TLS implementation</span><br><span class="line">Group:System Environment/Libraries</span><br><span class="line">License:GPLv2+</span><br><span class="line">URL:https://www.openssl.org/</span><br><span class="line">Source0:https://www.openssl.org/<span class="built_in">source</span>/%&#123;name&#125;-%&#123;version&#125;.tar.gz</span><br><span class="line">BuildRequires:make gcc perl perl-WWW-Curl</span><br><span class="line">Requires:%&#123;name&#125; = %&#123;version&#125;-%&#123;release&#125;</span><br><span class="line">BuildRoot:%_topdir/BUILDROOT</span><br><span class="line"></span><br><span class="line">%global openssldir /usr/openssl</span><br><span class="line"></span><br><span class="line">%description</span><br><span class="line">The OpenSSL toolkit provides support <span class="keyword">for</span> secure communications between</span><br><span class="line">machines. OpenSSL includes a certificate management tool and shared</span><br><span class="line">libraries <span class="built_in">which</span> provide various cryptographic algorithms and</span><br><span class="line">protocols.</span><br><span class="line"></span><br><span class="line">%prep</span><br><span class="line">%setup -q</span><br><span class="line"></span><br><span class="line">%build</span><br><span class="line">./config --prefix=%&#123;openssldir&#125; --openssldir=%&#123;openssldir&#125;</span><br><span class="line">make %&#123;?_smp_mflags&#125;</span><br><span class="line"></span><br><span class="line">%install</span><br><span class="line">[ <span class="string">&quot;%&#123;buildroot&#125;&quot;</span> != <span class="string">&quot;/&quot;</span> ] &amp;&amp; %&#123;__rm&#125; -rf %&#123;buildroot&#125;</span><br><span class="line">%make_install</span><br><span class="line">mkdir -p %&#123;buildroot&#125;%&#123;_bindir&#125;</span><br><span class="line">mkdir -p %&#123;buildroot&#125;%&#123;_libdir&#125;</span><br><span class="line">ln -sf %&#123;openssldir&#125;/lib/libssl.so.1.1 %&#123;buildroot&#125;%&#123;_libdir&#125;</span><br><span class="line">ln -sf %&#123;openssldir&#125;/lib/libcrypto.so.1.1 %&#123;buildroot&#125;%&#123;_libdir&#125;</span><br><span class="line">ln -sf %&#123;openssldir&#125;/bin/openssl %&#123;buildroot&#125;%&#123;_bindir&#125;</span><br><span class="line"></span><br><span class="line">%clean</span><br><span class="line">[ <span class="string">&quot;%&#123;buildroot&#125;&quot;</span> != <span class="string">&quot;/&quot;</span> ] &amp;&amp; %&#123;__rm&#125; -rf %&#123;buildroot&#125;</span><br><span class="line"></span><br><span class="line">%files</span><br><span class="line">%&#123;openssldir&#125;</span><br><span class="line">%defattr(-,root,root)</span><br><span class="line">%&#123;_bindir&#125;/openssl</span><br><span class="line">%&#123;_libdir&#125;/libcrypto.so.1.1</span><br><span class="line">%&#123;_libdir&#125;/libssl.so.1.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%post -p /sbin/ldconfig</span><br><span class="line"></span><br><span class="line">%postun -p /sbin/ldconfig</span><br><span class="line"></span><br><span class="line">%changelog</span><br><span class="line">* Sat May 08 2021 Hebin Wan &lt;wanhebin@outlook.com&gt; - 1.1.1k</span><br><span class="line">- Rebuilt <span class="keyword">for</span> https://www.openssl.org/<span class="built_in">source</span>/openssl-1.1.1k.tar.gz </span><br></pre></td></tr></table></figure><h4 id="2-4-使用-rpmlint-测试"><a href="#2-4-使用-rpmlint-测试" class="headerlink" title="2.4 使用 rpmlint 测试"></a>2.4 使用 rpmlint 测试</h4><p>为避免常见错误，请先使用 <code>rpmlint</code> 查找 SPEC 文件的错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rpmlint ~/rpmbuild/SPECS/openssl.spec</span><br><span class="line">0 packages and 1 specfiles checked; 0 errors, 0 warnings.</span><br></pre></td></tr></table></figure><p>如果返回错误/警告，使用 “<code>-i</code>“ 选项查看更详细的信息。</p><h4 id="2-5-从-SPEC-构建-RPM-包"><a href="#2-5-从-SPEC-构建-RPM-包" class="headerlink" title="2.5 从 SPEC 构建 RPM 包"></a>2.5 从 SPEC 构建 RPM 包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rpmbuild -D <span class="string">&quot;version 1.1.1k&quot;</span> -ba ~/rpmbuild/SPECS/openssl.spec</span><br></pre></td></tr></table></figure><blockquote><p>-ba    构建源代码rpm包和二进制rpm包</p><p>-bb    只构建二进制rpm包</p><p>-bs    只构建源代码rpm包</p><p>-bp    执行至％prep阶段（解压源并应用补丁）</p><p>-bc    执行至％build阶段（％prep，然后编译）</p><p>-bi    执行至％install阶段（％prep，％build，然后安装）</p><p>-bl    验证％files部分，查看文件是否存在</p></blockquote><ul><li>构建完成后，有类似下面的返回内容时，说明 RPM 包构建成功了</li></ul><p><img src="https://pic-cdn.wanhebin.com/2021/05/08/fa86f7ff0af42.png" alt="rpmbuild_openssl-1.png"></p><ul><li>查看构建成功的 RPM 包</li></ul><p><img src="https://pic-cdn.wanhebin.com/2021/05/08/bab7e202e600d.png" alt="rpmbuild_openssl-2.png"></p><p>在RPMS文件夹下生成了 <code>RPM</code> 包，在 <code>x86_64</code> 下，表示所应用的架构，由于没有指定arch为 <code>noarch</code> ，所以默认用本机架构。在SRPMS文件夹下生成了源码 <code>RPM</code> 包。</p><h4 id="2-6-使用-rpmlint-测试已构建的-RPM-包"><a href="#2-6-使用-rpmlint-测试已构建的-RPM-包" class="headerlink" title="2.6 使用 rpmlint 测试已构建的 RPM 包"></a>2.6 使用 rpmlint 测试已构建的 RPM 包</h4><p><code>rpmlint</code> 用于检查 SPEC/RPM/SRPM 是否存在错误。你需要在发布软件包之前，解决这些警告。<a href="https://fedoraproject.org/wiki/Common_Rpmlint_issues">此页面</a> 提供一些常见问题的解释。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rpmlint ~/rpmbuild/SPECS/openssl.spec ~/rpmbuild/RPMS/x86_64/openssl-1.1.1k-1.el7.x86_64.rpm ~/rpmbuild/SRPMS/openssl-1.1.1k-1.el7.src.rpm</span><br></pre></td></tr></table></figure><p>一般情况下，检测到的都是一些WARN信息，不影响软件使用，可以忽略。如果有ERROR信息，或许也不影响使用，但建议按照提示进行调整、修复。</p><h2 id="三、安装升级-OpenSSL"><a href="#三、安装升级-OpenSSL" class="headerlink" title="三、安装升级 OpenSSL"></a>三、安装升级 OpenSSL</h2><p>一般情况下，系统都已经有openssl了，所以我们直接升级即可。</p><blockquote><p><strong>注意：</strong></p><p>切记！在做openssl升级时，请先从测试机中操作，升级后，确定没有任何问题时，在根据线上环境陆续升级。</p></blockquote><h4 id="3-1-检查系统当前OpenSSL版本"><a href="#3-1-检查系统当前OpenSSL版本" class="headerlink" title="3.1 检查系统当前OpenSSL版本"></a>3.1 检查系统当前OpenSSL版本</h4><p>查看当前系统中openssl的版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl version</span><br><span class="line">OpenSSL 1.0.2k-fips  26 Jan 2017</span><br></pre></td></tr></table></figure><p>卸载openssl</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -e openssl --nodeps</span><br></pre></td></tr></table></figure><h4 id="3-2-升级OpenSSL版本"><a href="#3-2-升级OpenSSL版本" class="headerlink" title="3.2 升级OpenSSL版本"></a>3.2 升级OpenSSL版本</h4><p>安装我们刚刚打包好的openssl 1.1.1k版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -ivh ~/rpmbuild/RPMS/x86_64/openssl-1.1.1k-2.el7.x86_64.rpm --nodeps</span><br><span class="line">Preparing...                          <span class="comment">################################# [100%]</span></span><br><span class="line">Updating / installing...</span><br><span class="line">   1:openssl-1.1.1k-2.el7             <span class="comment">################################# [100%]</span></span><br></pre></td></tr></table></figure><p>再次查看系统中openssl版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl version</span><br><span class="line">OpenSSL 1.1.1k  25 Mar 2021</span><br></pre></td></tr></table></figure><p>很幸运，成功升级！</p><p>但是否对系统环境、其他软件功能有影响，这个就需要我们进一步测试，笔者这里就省略了。</p><p><strong>参考文献</strong></p><ul><li><a href="https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn">How to create an RPM package</a></li><li><a href="https://fedoraproject.org/wiki/How_to_create_a_GNU_Hello_RPM_package/zh-cn">How to create a GNU Hello RPM package</a></li><li><a href="https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Packagers_Guide/chap-Packagers_Guide-Spec_File_Reference-Preamble.html">Spec File Preamble</a></li><li><a href="https://fedoraproject.org/wiki/Common_Rpmlint_issues">Common Rpmlint issues</a></li><li><a href="https://blog.csdn.net/get_set/article/details/53453320">RPM打包原理、示例、详解及备查</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> OpenSSL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenSSL </tag>
            
            <tag> RPM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB副本集把SECONDARY提升为PRIMARY</title>
      <link href="posts/mongodb-replica-set-promotes-secondary-to-primary/"/>
      <url>posts/mongodb-replica-set-promotes-secondary-to-primary/</url>
      
        <content type="html"><![CDATA[<h2 id="事故背景"><a href="#事故背景" class="headerlink" title="事故背景"></a>事故背景</h2><p>​        线上环境有一个MongoDB副本集，由于是部署在客户那边本地机房，客户误操作把部署副本集的另外2个节点的 VM 给删除了（并且VM已经无法恢复了）。所幸的是还有一个节点存活，登录节点后发现这个节点是 SECONDARY，所以可能会有一部分数据丢失，而且此时已经无法对应用提供读写服务。此时只能停服维护，并对集群进行恢复。</p><p>​        基于以上问题，下面对副本集恢复操作步鄹进行了记录。</p><h2 id="处理思路"><a href="#处理思路" class="headerlink" title="处理思路"></a>处理思路</h2><ol><li>对mongodb数据进行备份（防止恢复集群时出现意外导致数据丢失）。</li><li>把仅存的 SECONDARY 节点提升为 PRIMARY，删除集群中另外2个不存活的节点，然后重新配置MongoDB副本集。</li><li>新部署2个MongoDB节点，并加入到集群中。</li><li>等待 PRIMARY 节点数据同步到另外2个新节点后，进行数据验证，结束生产环境维护。</li></ol><blockquote><p><strong>注意：</strong></p><p>由于原先的集群中只存有 SECONDARY 节点，PRIMARY 节点已经丢失，所以存在部署数据没同步到 SECONDARY 的可能。但由于PRIMARY节点的VM已经被删，这部分未同步的数据的丢失在所难免，想恢复这部分数据只能根据自己的业务、代码逻辑设定才有补上丢失的数据的可能性。</p></blockquote><h2 id="集群恢复"><a href="#集群恢复" class="headerlink" title="集群恢复"></a>集群恢复</h2><h3 id="1、在SECONDARY节点删除挂掉的primary节点"><a href="#1、在SECONDARY节点删除挂掉的primary节点" class="headerlink" title="1、在SECONDARY节点删除挂掉的primary节点"></a>1、在SECONDARY节点删除挂掉的primary节点</h3><h4 id="1-1-查看当前副本集配置"><a href="#1-1-查看当前副本集配置" class="headerlink" title="1.1 查看当前副本集配置"></a>1.1 查看当前副本集配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs1:SECONDARY&gt; rs.conf()</span><br></pre></td></tr></table></figure><p>输出内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">rs1:SECONDARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">rs1:SECONDARY&gt; rs_conf = rs.<span class="function"><span class="title">config</span></span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : <span class="string">&quot;rs1&quot;</span>,</span><br><span class="line"><span class="string">&quot;version&quot;</span> : 7,</span><br><span class="line"><span class="string">&quot;protocolVersion&quot;</span> : NumberLong(1),</span><br><span class="line"><span class="string">&quot;members&quot;</span> : [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line"><span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;priority&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line"><span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.30.213:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;priority&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line"><span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 2,</span><br><span class="line"><span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.30.214:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;priority&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line"><span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;settings&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;chainingAllowed&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;heartbeatIntervalMillis&quot;</span> : 2000,</span><br><span class="line"><span class="string">&quot;heartbeatTimeoutSecs&quot;</span> : 10,</span><br><span class="line"><span class="string">&quot;electionTimeoutMillis&quot;</span> : 10000,</span><br><span class="line"><span class="string">&quot;catchUpTimeoutMillis&quot;</span> : -1,</span><br><span class="line"><span class="string">&quot;catchUpTakeoverDelayMillis&quot;</span> : 30000,</span><br><span class="line"><span class="string">&quot;getLastErrorModes&quot;</span> : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;getLastErrorDefaults&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;w&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;wtimeout&quot;</span> : 0</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;replicaSetId&quot;</span> : ObjectId(<span class="string">&quot;5f5094994a4d5004eae73e2f&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-删除集群成员"><a href="#1-2-删除集群成员" class="headerlink" title="1.2 删除集群成员"></a>1.2 删除集群成员</h4><ul><li><strong>比如要删除members中 host 为 <code>192.168.30.213:27017</code> 的成员，通过<code>rs.conf()</code>找到成员的 <code>_id</code></strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.30.213:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;priority&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line"><span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><ul><li><strong>删除 <code>_id</code> 为1的成员</strong></li></ul><blockquote><p>splice的第一个参数表示要删除的数组元素的下标</p><p>0 表示集群中成员节点的 <code>&quot;_id&quot;</code> </p><p>1 表示删除的个数</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rs1:SECONDARY&gt; rs_conf = rs.conf()</span><br><span class="line">rs1:SECONDARY&gt; rs_conf.members.splice(0,1)</span><br></pre></td></tr></table></figure><p>输出内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rs1:SECONDARY&gt; rs_conf.members.splice(1,1)</span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.30.213:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;priority&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line"><span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>依照此方法删除副本集中不存活的节点。</p><blockquote><p><strong>注意：</strong></p><p>有一点需要注意，由于已经删除了 <code>_id</code> 为1的成员，所以后面的成员的 <code>_id</code> 号都会减小1，与数组中元素的下标相同。</p></blockquote><h3 id="2、重新配置MongoDB副本集"><a href="#2、重新配置MongoDB副本集" class="headerlink" title="2、重新配置MongoDB副本集"></a>2、重新配置MongoDB副本集</h3><h4 id="2-1-重置集群配置"><a href="#2-1-重置集群配置" class="headerlink" title="2.1 重置集群配置"></a>2.1 重置集群配置</h4><p><code>rs_conf</code> 就是上面修改后的配置，加force参数是因为 SECONDARY 默认没有执行此命令的权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs1:SECONDARY&gt; rs.reconfig(rs_conf, &#123;<span class="string">&quot;force&quot;</span>:<span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure><p>返回内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rs1:SECONDARY&gt; rs.reconfig(rs_conf, &#123;<span class="string">&quot;force&quot;</span>:<span class="literal">true</span>&#125;)</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1619586716, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1619588924, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">rs1:PRIMARY&gt; </span><br></pre></td></tr></table></figure><h4 id="2-2-查看集群状态"><a href="#2-2-查看集群状态" class="headerlink" title="2.2 查看集群状态"></a>2.2 查看集群状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.status()</span><br></pre></td></tr></table></figure><p>返回内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;set&quot;</span> : <span class="string">&quot;rs1&quot;</span>,</span><br><span class="line"><span class="string">&quot;date&quot;</span> : ISODate(<span class="string">&quot;2021-04-28T05:51:03.672Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;myState&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;term&quot;</span> : NumberLong(17),</span><br><span class="line"><span class="string">&quot;syncingTo&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line"><span class="string">&quot;heartbeatIntervalMillis&quot;</span> : NumberLong(2000),</span><br><span class="line"><span class="string">&quot;optimes&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;lastCommittedOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1619589055, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(17)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;readConcernMajorityOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1619589055, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(17)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;appliedOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1619589055, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(17)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;durableOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1619589055, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(17)</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;members&quot;</span> : [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line"><span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;state&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line"><span class="string">&quot;uptime&quot;</span> : 7482,</span><br><span class="line"><span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1619589055, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(17)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2021-04-28T05:50:55Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;syncingTo&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;syncSourceHost&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;syncSourceId&quot;</span> : -1,</span><br><span class="line"><span class="string">&quot;infoMessage&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;electionTime&quot;</span> : Timestamp(1619588924, 1),</span><br><span class="line"><span class="string">&quot;electionDate&quot;</span> : ISODate(<span class="string">&quot;2021-04-28T05:48:44Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;configVersion&quot;</span> : 124340,</span><br><span class="line"><span class="string">&quot;self&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;lastHeartbeatMessage&quot;</span> : <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1619589055, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1619589055, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时发现，这个 SECONDARY 节点已经提升为 PRIMARY，并且集群状态中，也就只有我们当前一个节点。</p><p>接下来就可以向副本集中添加新的MongoDB节点了。</p><h3 id="3、添加新的MongoDB节点"><a href="#3、添加新的MongoDB节点" class="headerlink" title="3、添加新的MongoDB节点"></a>3、添加新的MongoDB节点</h3><p>这里省略新节点的部署过程，具体可以参考[《MongoDB 单节点升级为副本集高可用集群》](<a href="https://www.wanhebin.com/database/mongodb/1005.html">MongoDB 单节点升级为副本集高可用集群 - HEBIN博客 (wanhebin.com)</a>)文章中MongoDB节点部署的步鄹。</p><blockquote><p><strong>注意：</strong></p><p>向mongodb副本集添加实例后，PRIMARY节点数据能够自动同步到新添加的SECONDARY节点，无需人工干预。</p></blockquote><h4 id="3-1-增加实例"><a href="#3-1-增加实例" class="headerlink" title="3.1 增加实例"></a>3.1 增加实例</h4><p>登录PRIMARY节点，添加MongoDB实例。</p><p>新添加的实例优先级权重默认为1，如需调整，建议等数据同步完成后进行权重更改。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; use admin</span><br><span class="line">rs1:PRIMARY&gt; rs.add(<span class="string">&#x27;192.168.30.213:27017&#x27;</span>)</span><br><span class="line">rs1:PRIMARY&gt; rs.add(<span class="string">&#x27;192.168.30.214:27017&#x27;</span>)</span><br></pre></td></tr></table></figure><p>添加节点的返回结果如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.add(<span class="string">&#x27;192.168.30.213:27017&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1619581966, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1619581966, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">rs1:PRIMARY&gt; rs.add(<span class="string">&#x27;192.168.30.214:27017&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1619581975, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1619581975, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-删除实例"><a href="#3-2-删除实例" class="headerlink" title="3.2 删除实例"></a>3.2 删除实例</h4><p>如果添加错节点时，可以通过 <code>rs.remove()</code> 来删除错误的节点（因为此时当前实例已经是 PRIMARY 了，所以不需要用 1.2 中方法剔除节点）。</p><p>从mongodb副本集中移除实例，不可移除primary</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; use admin</span><br><span class="line">rs1:PRIMARY&gt; rs.remove(<span class="string">&#x27;192.168.30.214:27017&#x27;</span>)</span><br></pre></td></tr></table></figure><p>返回内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.remove(<span class="string">&#x27;192.168.30.213:27017&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1619581713, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1619581713, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">rs1:PRIMARY&gt; rs.remove(<span class="string">&#x27;192.168.30.214:27017&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1619581777, 2),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1619581777, 2),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：</strong></p><p>副本集经过添加删除后顺序会乱，可以根据需要设置权重来调整。</p></blockquote><h3 id="4、调整节点权重"><a href="#4、调整节点权重" class="headerlink" title="4、调整节点权重"></a>4、调整节点权重</h3><p>如果想在集群宕机恢复后，还想让某一节点始终保持为 PRIMARY，可以把此节点的权重设置成最大。</p><h4 id="4-1-设置权重"><a href="#4-1-设置权重" class="headerlink" title="4.1 设置权重"></a>4.1 设置权重</h4><p>找到对应节点在副本集中成员<code>_id</code>，进行权重设置。</p><p>这里以成员0为例，其host为<code>192.168.30.207:27017</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs_conf = rs.config()</span><br><span class="line">rs1:PRIMARY&gt; rs_conf.members[0].priority=10</span><br></pre></td></tr></table></figure><h4 id="4-2-生效配置"><a href="#4-2-生效配置" class="headerlink" title="4.2 生效配置"></a>4.2 生效配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.reconfig(rs_conf)</span><br></pre></td></tr></table></figure><p>返回结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.reconfig(rs_conf)</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1619591404, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1619591404, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-验证权重配置"><a href="#4-3-验证权重配置" class="headerlink" title="4.3 验证权重配置"></a>4.3 验证权重配置</h4><ul><li><strong>查询成员0的权重</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.config()</span><br></pre></td></tr></table></figure><p>返回内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line"><span class="string">&quot;host&quot;</span> : <span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;arbiterOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;buildIndexes&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;hidden&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;priority&quot;</span> : 10,</span><br><span class="line"><span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;slaveDelay&quot;</span> : NumberLong(0),</span><br><span class="line"><span class="string">&quot;votes&quot;</span> : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>模拟宕机恢复后的集群状态</strong></li></ul><p>关闭三个节点的mongodb服务，再无序恢复，然后连接进节点<code>192.168.30.207:27017</code>，成员0依然还是PRIMARY。（为了必然偶然性，可以进行多次测试）</p>]]></content>
      
      
      <categories>
          
          <category> MongoDB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP 安装 pdo_sqlsrv 扩展(CentOS7)</title>
      <link href="posts/php-install-pdo_sqlsrv-extension/"/>
      <url>posts/php-install-pdo_sqlsrv-extension/</url>
      
        <content type="html"><![CDATA[<h3 id="一、安装相关依赖"><a href="#一、安装相关依赖" class="headerlink" title="一、安装相关依赖"></a>一、安装相关依赖</h3><h4 id="1-1-安装微软源"><a href="#1-1-安装微软源" class="headerlink" title="1.1 安装微软源"></a>1.1 安装微软源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s -o /tmp/prod.repo https://packages.microsoft.com/config/rhel/7/prod.repo</span><br></pre></td></tr></table></figure><h4 id="1-2-防止冲突先卸载原有版本-可选"><a href="#1-2-防止冲突先卸载原有版本-可选" class="headerlink" title="1.2 防止冲突先卸载原有版本(可选)"></a>1.2 防止冲突先卸载原有版本(可选)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum remove -y unixODBC </span><br></pre></td></tr></table></figure><h4 id="1-3-安装驱动（三个都要装上，缺一不可）"><a href="#1-3-安装驱动（三个都要装上，缺一不可）" class="headerlink" title="1.3 安装驱动（三个都要装上，缺一不可）"></a>1.3 安装驱动（三个都要装上，缺一不可）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y msodbcsql mssql-tools unixODBC-devel</span><br></pre></td></tr></table></figure><h3 id="二、编译pdo-sqlsrv插件"><a href="#二、编译pdo-sqlsrv插件" class="headerlink" title="二、编译pdo_sqlsrv插件"></a>二、编译pdo_sqlsrv插件</h3><h4 id="2-1-下载pdo-sqlsrv扩展包"><a href="#2-1-下载pdo-sqlsrv扩展包" class="headerlink" title="2.1 下载pdo_sqlsrv扩展包"></a>2.1 下载pdo_sqlsrv扩展包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://pecl.php.net/get/pdo_sqlsrv-5.9.0.tgz</span><br></pre></td></tr></table></figure><h4 id="2-2-解压编译"><a href="#2-2-解压编译" class="headerlink" title="2.2 解压编译"></a>2.2 解压编译</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar xf pdo_sqlsrv-5.9.0.tgz</span><br><span class="line">$ <span class="built_in">cd</span> pdo_sqlsrv-5.9.0</span><br></pre></td></tr></table></figure><h4 id="2-3-预编译"><a href="#2-3-预编译" class="headerlink" title="2.3 预编译"></a>2.3 预编译</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/phpize</span><br><span class="line">$ ./configure --with-php-config=/usr/bin/php-config</span><br></pre></td></tr></table></figure><h4 id="2-4-编译安装"><a href="#2-4-编译安装" class="headerlink" title="2.4 编译安装"></a>2.4 编译安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="三、添加pdo-sqlsrv扩展"><a href="#三、添加pdo-sqlsrv扩展" class="headerlink" title="三、添加pdo_sqlsrv扩展"></a>三、添加pdo_sqlsrv扩展</h3><p>本文是使用yum安装的php、php-fpm，相关配置文件路径可能与各路大神们的环境不太相同（根据自己环境找到相关配置文件）。</p><ul><li>在 <code>/etc/php.ini</code> 配置文件中添加 <code>pdo_sqlsrv.so</code> 扩展。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extension=pdo.so</span><br><span class="line">extension=pdo_sqlsrv.so</span><br></pre></td></tr></table></figure><blockquote><p><code>pdo_sqlsrv.so</code> 是sqlserver扩展，需要在 <code>pdo.so</code> 扩展之前加载，否则会出现如下报错</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP Warning:  PHP Startup: Unable to load dynamic library <span class="string">&#x27;/usr/lib64/php/modules/pdo_sqlsrv.so&#x27;</span> - /usr/lib64/php/modules/pdo_sqlsrv.so: undefined symbol: php_pdo_register_driver <span class="keyword">in</span> Unknown on line 0</span><br></pre></td></tr></table></figure></blockquote><ul><li>重启php-fpm服务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart php-fpm</span><br></pre></td></tr></table></figure><h3 id="四、验证扩展是否正确安装"><a href="#四、验证扩展是否正确安装" class="headerlink" title="四、验证扩展是否正确安装"></a>四、验证扩展是否正确安装</h3><ul><li><strong>验证扩展是否成功安装</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php -m | grep pdo_sqlsrv</span><br></pre></td></tr></table></figure><p><img src="http://pic-cdn.wanhebin.com/2021/03/22/1399720dd2d6f.png" alt="php-pdo_sqlsrv-1.png"></p><p>这里可以看到 <code>pdo_sqlsrv</code>扩展已经添加到php中了。</p><p>但是又出现了<code>PHP Warning:  Module &#39;PDO&#39; already loaded in Unknown on line 0</code>的Warning信息。</p><p>经过排查，发现在 <code>/etc/php.d/pdo.ini</code> 配置文件中也引用了 <code>pdo.so</code> 扩展：</p><p><img src="http://pic-cdn.wanhebin.com/2021/03/22/f244dcafb7de3.png" alt="php-pdo_sqlsrv-2.png"></p><p>把 <code>/etc/php.d/pdo.ini</code> 中引用的 <code>pdo.so</code> 扩展注释，只保留 <code>/etc/php.ini</code> 中的此扩展即可。</p><p>注释后重启php-fpm，重新查看php扩展，此时Warning信息就没出现了。</p><p><img src="http://pic-cdn.wanhebin.com/2021/03/22/188c17265c17c.png" alt="php-pdo_sqlsrv-3.png"></p><ul><li><strong>在Web端查看PHP信息</strong></li></ul><p><img src="http://pic-cdn.wanhebin.com/2021/03/22/99aa5a234d62d.png" alt="php-pdo_sqlsrv-4.png"></p>]]></content>
      
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB单节点升级为副本集高可用集群</title>
      <link href="posts/MongoDB-single-node-upgraded-to-replica-set-cluster/"/>
      <url>posts/MongoDB-single-node-upgraded-to-replica-set-cluster/</url>
      
        <content type="html"><![CDATA[<h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>由于历史原因，我们有一个作数据同步的业务，生产环境中MongoDB使用的是单节点。但随着业务增长，考虑到这个同步业务的重要性，避免由于单节点故障造成业务停止，所以需要升级为副本集保证高可用。</p><h3 id="副本集架构"><a href="#副本集架构" class="headerlink" title="副本集架构"></a>副本集架构</h3><p>下面这架构图是这篇文章需要实现的MongoDB副本集高可用架构：</p><p><img src="http://pic-cdn.wanhebin.com/2021/01/20/7828ee3df93d9.png#pic_center" alt="MongoDB_ReplicaSetArchitecture-2.png"></p><h3 id="升级架构前注意事项"><a href="#升级架构前注意事项" class="headerlink" title="升级架构前注意事项"></a>升级架构前注意事项</h3><p>在生产环境中，做单节点升级到集群前，一定要先备份好mongodb的所有数据，避免操作失误导致数据丢失。</p><p>并且在保证在升级期间不会有程序连接到MongoDB进行读写操作，建议停服务升级，且在凌晨业务低峰期，进行操作。</p><h3 id="一、原单节点MongoDB配置信息"><a href="#一、原单节点MongoDB配置信息" class="headerlink" title="一、原单节点MongoDB配置信息"></a>一、原单节点MongoDB配置信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IP: 192.168.30.207</span><br><span class="line">Port: 27017</span><br></pre></td></tr></table></figure><h4 id="1-1-原配置文件"><a href="#1-1-原配置文件" class="headerlink" title="1.1 原配置文件"></a>1.1 原配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">  destination: file   </span><br><span class="line">  logAppend: <span class="literal">true</span>  </span><br><span class="line">  path: /home/server/mongodb/logs/mongodb.log</span><br><span class="line"></span><br><span class="line">storage:</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  dbPath: /home/server/mongodb/data</span><br><span class="line">  directoryPerDB: <span class="literal">true</span></span><br><span class="line">  wiredTiger:</span><br><span class="line">     engineConfig:</span><br><span class="line">        cacheSizeGB: 1</span><br><span class="line">        directoryForIndexes: <span class="literal">true</span></span><br><span class="line">     collectionConfig:</span><br><span class="line">        blockCompressor: zlib</span><br><span class="line">     indexConfig:</span><br><span class="line">        prefixCompression: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /home/server/mongodb/pid/mongod.pid</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1,192.168.30.207</span><br><span class="line">  maxIncomingConnections: 5000</span><br><span class="line"></span><br><span class="line">security:</span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure><h4 id="1-2-在原来配置文件增加副本集配置"><a href="#1-2-在原来配置文件增加副本集配置" class="headerlink" title="1.2 在原来配置文件增加副本集配置"></a>1.2 在原来配置文件增加副本集配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replication:</span><br><span class="line">  oplogSizeMB: 4096</span><br><span class="line">  replSetName: rs1</span><br></pre></td></tr></table></figure><blockquote><p>注意：这里需要先把 <strong>认证</strong> 配置注释，副本集配置完成后再开启。</p></blockquote><h3 id="二、新增节点信息"><a href="#二、新增节点信息" class="headerlink" title="二、新增节点信息"></a>二、新增节点信息</h3><table><thead><tr><th>角色</th><th>IP</th><th>Port</th><th></th></tr></thead><tbody><tr><td>PRIMARY</td><td>192.168.30.207</td><td>27017</td><td>原单节点MongoDB</td></tr><tr><td>SECONDARY</td><td>192.168.30.213</td><td>27017</td><td>新增节点1</td></tr><tr><td>SECONDARY</td><td>192.168.30.214</td><td>27017</td><td>新增节点2</td></tr></tbody></table><h4 id="2-1-新增节点配置文件"><a href="#2-1-新增节点配置文件" class="headerlink" title="2.1 新增节点配置文件"></a>2.1 新增节点配置文件</h4><p>这两个SECONDARY节点配置文件，只需复制PRIMARY节点配置文件，并修改相应的 “<strong>bindIp</strong>“即可。</p><ul><li>SECONDARY 节点1配置文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">  destination: file   </span><br><span class="line">  logAppend: <span class="literal">true</span>  </span><br><span class="line">  path: /home/server/mongodb/logs/mongodb.log</span><br><span class="line"></span><br><span class="line">storage:</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  dbPath: /home/server/mongodb/data</span><br><span class="line">  directoryPerDB: <span class="literal">true</span></span><br><span class="line">  wiredTiger:</span><br><span class="line">     engineConfig:</span><br><span class="line">        cacheSizeGB: 1</span><br><span class="line">        directoryForIndexes: <span class="literal">true</span></span><br><span class="line">     collectionConfig:</span><br><span class="line">        blockCompressor: zlib</span><br><span class="line">     indexConfig:</span><br><span class="line">        prefixCompression: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /home/server/mongodb/pid/mongod.pid</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1,192.168.30.213</span><br><span class="line">  maxIncomingConnections: 5000</span><br><span class="line"></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line">  <span class="comment">#authorization: enabled</span></span><br><span class="line"></span><br><span class="line">replication:</span><br><span class="line">  oplogSizeMB: 4096</span><br><span class="line">  replSetName: rs1</span><br></pre></td></tr></table></figure><ul><li>SECONDARY 节点2配置文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">  destination: file   </span><br><span class="line">  logAppend: <span class="literal">true</span>  </span><br><span class="line">  path: /home/server/mongodb/logs/mongodb.log</span><br><span class="line"></span><br><span class="line">storage:</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  dbPath: /home/server/mongodb/data</span><br><span class="line">  directoryPerDB: <span class="literal">true</span></span><br><span class="line">  wiredTiger:</span><br><span class="line">     engineConfig:</span><br><span class="line">        cacheSizeGB: 1</span><br><span class="line">        directoryForIndexes: <span class="literal">true</span></span><br><span class="line">     collectionConfig:</span><br><span class="line">        blockCompressor: zlib</span><br><span class="line">     indexConfig:</span><br><span class="line">        prefixCompression: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /home/server/mongodb/pid/mongod.pid</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1,192.168.30.214</span><br><span class="line">  maxIncomingConnections: 5000</span><br><span class="line"></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line">  <span class="comment">#authorization: enabled</span></span><br><span class="line"></span><br><span class="line">replication:</span><br><span class="line">  oplogSizeMB: 4096</span><br><span class="line">  replSetName: rs1</span><br></pre></td></tr></table></figure><h4 id="2-2-启动3个节点"><a href="#2-2-启动3个节点" class="headerlink" title="2.2 启动3个节点"></a>2.2 启动3个节点</h4><p>PRIMARY节点需要重启，2个SECONDARY节点直接启动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动命令</span></span><br><span class="line">$ mongo -f /home/server/mongodb/conf/mongo.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#停止命令</span></span><br><span class="line">$ mongo -f /home/server/mongodb/conf/mongo.conf --shutdown</span><br></pre></td></tr></table></figure><h3 id="三、初始化副本集"><a href="#三、初始化副本集" class="headerlink" title="三、初始化副本集"></a>三、初始化副本集</h3><p>使用mongo shell连接到其中一个节点，执行初始化命令</p><h4 id="3-1-初始化配置"><a href="#3-1-初始化配置" class="headerlink" title="3.1 初始化配置"></a>3.1 初始化配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;</span><br><span class="line">  _id : <span class="string">&quot;rs1&quot;</span>, </span><br><span class="line">  members : [</span><br><span class="line">    &#123;_id:0, host:<span class="string">&quot;192.168.30.207:27017&quot;</span>&#125;,</span><br><span class="line">    &#123;_id:1, host:<span class="string">&quot;192.168.30.213:27017&quot;</span>&#125;,</span><br><span class="line">    &#123;_id:2, host:<span class="string">&quot;192.168.30.214:27017&quot;</span>&#125;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://pic-cdn.wanhebin.com/2021/01/20/d5d7e835ab492.png#pic_center" alt="mongo_replica-1.png"></p><h4 id="3-2-对副本集进行初始化"><a href="#3-2-对副本集进行初始化" class="headerlink" title="3.2 对副本集进行初始化"></a>3.2 对副本集进行初始化</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; rs.initiate(config)//初始化副本集</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,//返回ok：1成功，返回ok：0失败</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1611042829, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1611042829, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://pic-cdn.wanhebin.com/2021/01/20/587bb23f66a55.png#pic_center" alt="mongo_replica-2.png"></p><h4 id="3-3-查看副本集状态"><a href="#3-3-查看副本集状态" class="headerlink" title="3.3 查看副本集状态"></a>3.3 查看副本集状态</h4><ul><li>查看集群状态信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.<span class="function"><span class="title">status</span></span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;set&quot;</span> : <span class="string">&quot;rs1&quot;</span>,</span><br><span class="line"><span class="string">&quot;date&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:53.063Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;myState&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;term&quot;</span> : NumberLong(2),</span><br><span class="line"><span class="string">&quot;heartbeatIntervalMillis&quot;</span> : NumberLong(2000),</span><br><span class="line"><span class="string">&quot;optimes&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;lastCommittedOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;readConcernMajorityOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;appliedOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;durableOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;members&quot;</span> : [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line"><span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;state&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line"><span class="string">&quot;uptime&quot;</span> : 52343,</span><br><span class="line"><span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:45Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;electionTime&quot;</span> : Timestamp(1611055182, 1),</span><br><span class="line"><span class="string">&quot;electionDate&quot;</span> : ISODate(<span class="string">&quot;2021-01-19T11:19:42Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;configVersion&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;self&quot;</span> : <span class="literal">true</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.30.213:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;state&quot;</span> : 2,</span><br><span class="line"><span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;SECONDARY&quot;</span>,</span><br><span class="line"><span class="string">&quot;uptime&quot;</span> : 52334,</span><br><span class="line"><span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;optimeDurable&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:45Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;optimeDurableDate&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:45Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;lastHeartbeat&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:52.487Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;lastHeartbeatRecv&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:52.487Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;pingMs&quot;</span> : NumberLong(0),</span><br><span class="line"><span class="string">&quot;syncingTo&quot;</span> : <span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;configVersion&quot;</span> : 1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : 2,</span><br><span class="line"><span class="string">&quot;name&quot;</span> : <span class="string">&quot;192.168.30.214:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;health&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;state&quot;</span> : 2,</span><br><span class="line"><span class="string">&quot;stateStr&quot;</span> : <span class="string">&quot;SECONDARY&quot;</span>,</span><br><span class="line"><span class="string">&quot;uptime&quot;</span> : 52328,</span><br><span class="line"><span class="string">&quot;optime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;optimeDurable&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;optimeDate&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:45Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;optimeDurableDate&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:45Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;lastHeartbeat&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:52.487Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;lastHeartbeatRecv&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T01:51:52.487Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;pingMs&quot;</span> : NumberLong(0),</span><br><span class="line"><span class="string">&quot;syncingTo&quot;</span> : <span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;configVersion&quot;</span> : 1</span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1611107505, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;9fl/3w/5Gwk4Qd7h3fkrQVQtPhM=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(<span class="string">&quot;6919423507650576385&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>查看延时从库信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.printSlaveReplicationInfo()</span><br><span class="line"><span class="built_in">source</span>: 192.168.30.213:27017</span><br><span class="line">syncedTo: Wed Jan 20 2021 09:52:05 GMT+0800 (CST)</span><br><span class="line">0 secs (0 hrs) behind the primary </span><br><span class="line"><span class="built_in">source</span>: 192.168.30.214:27017</span><br><span class="line">syncedTo: Wed Jan 20 2021 09:52:05 GMT+0800 (CST)</span><br><span class="line">0 secs (0 hrs) behind the primary</span><br></pre></td></tr></table></figure><ul><li>查看集群与主节点</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; rs.<span class="function"><span class="title">isMaster</span></span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;hosts&quot;</span> : [</span><br><span class="line"><span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;192.168.30.213:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;192.168.30.214:27017&quot;</span></span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;setName&quot;</span> : <span class="string">&quot;rs1&quot;</span>,</span><br><span class="line"><span class="string">&quot;setVersion&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;ismaster&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;secondary&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;primary&quot;</span> : <span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;me&quot;</span> : <span class="string">&quot;192.168.30.207:27017&quot;</span>,</span><br><span class="line"><span class="string">&quot;electionId&quot;</span> : ObjectId(<span class="string">&quot;7fffffff0000000000000002&quot;</span>),</span><br><span class="line"><span class="string">&quot;lastWrite&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;opTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611108985, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;lastWriteDate&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T02:16:25Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;majorityOpTime&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;ts&quot;</span> : Timestamp(1611108985, 1),</span><br><span class="line"><span class="string">&quot;t&quot;</span> : NumberLong(2)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;majorityWriteDate&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T02:16:25Z&quot;</span>)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;maxBsonObjectSize&quot;</span> : 16777216,</span><br><span class="line"><span class="string">&quot;maxMessageSizeBytes&quot;</span> : 48000000,</span><br><span class="line"><span class="string">&quot;maxWriteBatchSize&quot;</span> : 100000,</span><br><span class="line"><span class="string">&quot;localTime&quot;</span> : ISODate(<span class="string">&quot;2021-01-20T02:16:26.713Z&quot;</span>),</span><br><span class="line"><span class="string">&quot;logicalSessionTimeoutMinutes&quot;</span> : 30,</span><br><span class="line"><span class="string">&quot;minWireVersion&quot;</span> : 0,</span><br><span class="line"><span class="string">&quot;maxWireVersion&quot;</span> : 6,</span><br><span class="line"><span class="string">&quot;readOnly&quot;</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line"><span class="string">&quot;operationTime&quot;</span> : Timestamp(1611108985, 1),</span><br><span class="line"><span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;clusterTime&quot;</span> : Timestamp(1611108985, 1),</span><br><span class="line"><span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;/B6MSETtY8MEoZwXKABCkb1AMY8=&quot;</span>),</span><br><span class="line"><span class="string">&quot;keyId&quot;</span> : NumberLong(<span class="string">&quot;6919423507650576385&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="四、副本集开启认证"><a href="#四、副本集开启认证" class="headerlink" title="四、副本集开启认证"></a>四、副本集开启认证</h3><h4 id="4-1-通过主节点添加一个超级管理员账号"><a href="#4-1-通过主节点添加一个超级管理员账号" class="headerlink" title="4.1 通过主节点添加一个超级管理员账号"></a>4.1 通过主节点添加一个超级管理员账号</h4><blockquote><p><strong>注意</strong>：如果原先单节点mongo已经有了超级管理员账号，这可以忽略这个步鄹。</p></blockquote><p>只需在主节点添加用户，副本集会自动同步主节点上的数据。</p><p>需要注意的是，创建账号这一步需要在开启认证之前操作。</p><ul><li>创建超管账号</li></ul><p>超管用户：  mongouser        密码： 123456      认证库： admin</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mongo --host 192.168.30.207 --port 27017</span><br><span class="line">rs1:PRIMARY&gt; use admin</span><br><span class="line">rs1:PRIMARY&gt; db.createUser(&#123;user: <span class="string">&quot;mongouser&quot;</span>,<span class="built_in">pwd</span>: <span class="string">&quot;123456&quot;</span>,roles:[ &#123; role: <span class="string">&quot;root&quot;</span>, db:<span class="string">&quot;admin&quot;</span>&#125;]&#125;)</span><br></pre></td></tr></table></figure><ul><li>查看已创建的账号</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rs1:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">rs1:PRIMARY&gt; db.getUsers()</span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;_id&quot;</span> : <span class="string">&quot;admin.mongouser&quot;</span>,</span><br><span class="line"><span class="string">&quot;user&quot;</span> : <span class="string">&quot;mongouser&quot;</span>,</span><br><span class="line"><span class="string">&quot;db&quot;</span> : <span class="string">&quot;admin&quot;</span>,</span><br><span class="line"><span class="string">&quot;roles&quot;</span> : [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;role&quot;</span> : <span class="string">&quot;root&quot;</span>,</span><br><span class="line"><span class="string">&quot;db&quot;</span> : <span class="string">&quot;admin&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="4-2-创建副本集认证的key文件"><a href="#4-2-创建副本集认证的key文件" class="headerlink" title="4.2 创建副本集认证的key文件"></a>4.2 创建副本集认证的key文件</h4><blockquote><p>所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须有读的权限，否则将来会报错。<br>一定要保证密钥文件一致，文件位置随便。但是为了方便查找，建议每台机器都放到一个固定的位置，都放到和配置文件一起的目录中。</p></blockquote><ul><li>生成<code>mongo.keyfile</code>文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rand -base64 90 -out /home/server/mongodb/conf/mongo.keyfile</span><br></pre></td></tr></table></figure><ul><li>拷贝<code>mongo.keyfile</code>文件到另外2个节点相同目录下</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ scp /home/server/mongodb/conf/mongo.keyfile root@192.168.30.213:/home/server/mongodb/conf/</span><br><span class="line">$ scp /home/server/mongodb/conf/mongo.keyfile root@192.168.30.214:/home/server/mongodb/conf/</span><br></pre></td></tr></table></figure><h4 id="4-3-修改MongoDB配置文件，开启认证"><a href="#4-3-修改MongoDB配置文件，开启认证" class="headerlink" title="4.3 修改MongoDB配置文件，开启认证"></a>4.3 修改MongoDB配置文件，开启认证</h4><ul><li>在配置文件中添加、修改如下配置。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">  keyFile: /home/server/mongodb/conf/mongo.keyfile</span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure><ul><li>重启所有的mongo节点</li></ul><h4 id="4-4-验证副本集认证"><a href="#4-4-验证副本集认证" class="headerlink" title="4.4 验证副本集认证"></a>4.4 验证副本集认证</h4><p>使用用户名、免密、认证库登录MongoDB副本集主节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo -u mongouser -p 123456 --host 192.168.30.207 --port 27017 -authenticationDatabase admin</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> MongoDB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决 Elasticsearch 7.X 分片数量不足问题</title>
      <link href="posts/solve-shortage-of-es7.x-shards/"/>
      <url>posts/solve-shortage-of-es7.x-shards/</url>
      
        <content type="html"><![CDATA[<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>这是Logstash向ES请求创建新索引时，Logstash日志出现以下报错信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2021-01-11T13:23:52,381][WARN ][logstash.outputs.elasticsearch][main][08029a8bd56dc10a64b84e502acbac75</span><br><span class="line">f20dc2c03ac3454af5ea5a31d7aade2c] Could not index event to Elasticsearch. &#123;:status=&gt;400, :action=&gt;[<span class="string">&quot;ind</span></span><br><span class="line"><span class="string">ex&quot;</span>, &#123;:_id=&gt;nil, :_index=&gt;<span class="string">&quot;catalina-prod-openapi-2021.01.11&quot;</span>, :routing=&gt;nil, :_type=&gt;<span class="string">&quot;_doc&quot;</span>&#125;, <span class="comment">#&lt;LogStas</span></span><br><span class="line">h::Event:0x3a2c6612&gt;], :response=&gt;&#123;<span class="string">&quot;index&quot;</span>=&gt;&#123;<span class="string">&quot;_index&quot;</span>=&gt;<span class="string">&quot;catalina-prod-2021.01.11&quot;</span>, <span class="string">&quot;_type&quot;</span></span><br><span class="line">=&gt;<span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;_id&quot;</span>=&gt;nil, <span class="string">&quot;status&quot;</span>=&gt;400, <span class="string">&quot;error&quot;</span>=&gt;&#123;<span class="string">&quot;type&quot;</span>=&gt;<span class="string">&quot;validation_exception&quot;</span>, <span class="string">&quot;reason&quot;</span>=&gt;<span class="string">&quot;Validation Fa</span></span><br><span class="line"><span class="string">iled: 1: this action would add [2] total shards, but this cluster currently has [1000]/[1000] maximum s</span></span><br><span class="line"><span class="string">hards open;&quot;</span>&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>从日志可以找到报错信息，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Failed: 1: this action would add [2] total shards, but this cluster currently has [1000]/[1000] maximum</span><br><span class="line">shards open;</span><br></pre></td></tr></table></figure><blockquote><p><em>ES当前最大的分片数只有1000，并且已经占用满了，但是此时ES创建新索引时还需要2个分片。也就是说ES的分片数不够用了。</em></p></blockquote><p>&nbsp;</p><h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><p>从Elasticsearch7.X版本开始，每个node默认只允许有1000个分片，所以上述报错是因为集群分片数不足引起的。</p><h4 id="修改ES的分片数量"><a href="#修改ES的分片数量" class="headerlink" title="修改ES的分片数量"></a>修改ES的分片数量</h4><p>1、通过配置文件<code>elasticsearch.yml</code>修改节点（集群）分片数量，需要重启服务。（永久生效）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster.max_shards_per_node: 5000</span><br></pre></td></tr></table></figure><p>2、通过curl命令修改分片数量</p><blockquote><p>集群更新 API 有两种工作模式：</p><p>临时（Transient）</p><p>这些变更在集群重启之前一直会生效。一旦整个集群重启，这些配置就被清除。</p><p>永久（Persistent）</p><p>这些变更会永久存在直到被显式修改。即使全集群重启它们也会存活下来并覆盖掉静态配置文件里的选项。</p><p>临时或永久配置需要在 JSON 体里分别指定。</p></blockquote><ul><li>临时生效</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT -H <span class="string">&quot;Content-Type:application/json&quot;</span> http://localhost:9200/_cluster/settings -d <span class="string">&#x27;&#123; &quot;transient&quot;: &#123; &quot;cluster&quot;: &#123; &quot;max_shards_per_node&quot;: 5000 &#125; &#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure><ul><li>永久生效</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT -H <span class="string">&quot;Content-Type:application/json&quot;</span> http://localhost:9200/_cluster/settings -d <span class="string">&#x27;&#123; &quot;persistent&quot;: &#123; &quot;cluster&quot;: &#123; &quot;max_shards_per_node&quot;: 5000 &#125; &#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>&nbsp;</p><h4 id="查看分片数量"><a href="#查看分片数量" class="headerlink" title="查看分片数量"></a>查看分片数量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XGET http://localhost:9200/_cluster/settings?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;cluster&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;max_shards_per_node&quot;</span> : <span class="string">&quot;5000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;transient&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;cluster&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;max_shards_per_node&quot;</span> : <span class="string">&quot;5000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;</p><p><strong>参考文档</strong></p><ul><li><a href="https://blog.csdn.net/knight_zhou/article/details/105707342">https://blog.csdn.net/knight_zhou/article/details/105707342</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker Compose 部署 EFK</title>
      <link href="posts/docker-compose-deploys-efk/"/>
      <url>posts/docker-compose-deploys-efk/</url>
      
        <content type="html"><![CDATA[<h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><p>系统版本：CentOS 7.6</p><p>服务器配置：2H 4G</p><p>软件版本（docker镜像）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch 6.6.0</span><br><span class="line">kibana 6.6.0</span><br><span class="line">filebeat 6.6.0</span><br></pre></td></tr></table></figure><p>&nbsp;</p><h2 id="安装-Docker-CE"><a href="#安装-Docker-CE" class="headerlink" title="安装 Docker-CE"></a>安装 Docker-CE</h2><h3 id="添加-stable-版本的-docker-仓库"><a href="#添加-stable-版本的-docker-仓库" class="headerlink" title="添加 stable 版本的 docker 仓库"></a>添加 <code>stable</code> 版本的 docker 仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h3 id="安装-docker-ce"><a href="#安装-docker-ce" class="headerlink" title="安装 docker-ce"></a>安装 docker-ce</h3><h4 id="安装最新版的-docker"><a href="#安装最新版的-docker" class="headerlink" title="安装最新版的 docker"></a>安装最新版的 docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure><h4 id="安装指定版本-docker"><a href="#安装指定版本-docker" class="headerlink" title="安装指定版本 docker"></a>安装指定版本 docker</h4><ul><li>查询可安装的版本：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ yum list docker-ce --showduplicates | sort -r</span><br><span class="line"> * updates: mirrors.tuna.tsinghua.edu.cn</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line"> * extras: mirrors.huaweicloud.com</span><br><span class="line">docker-ce.x86_64            3:19.03.4-3.el7                     docker-ce-stable</span><br><span class="line">......</span><br><span class="line">docker-ce.x86_64            3:18.09.9-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.8-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.7-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.6-3.el7                     docker-ce-stable</span><br><span class="line">......</span><br><span class="line">docker-ce.x86_64            18.06.0.ce-3.el7                    docker-ce-stable</span><br></pre></td></tr></table></figure><ul><li>比如这里我们来安装 docker-ce-18.09.9 版本：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install docker-ce-18.09.9 docker-ce-cli-18.09.9 containerd.io -y</span><br></pre></td></tr></table></figure><p>安装完成，但是还没有启动，由于我这里的磁盘空间不大，所以需要更改下 Docker 的根目录，将默认的 <code>/var/lib/docker</code> 更改为 <code>/data/docker</code> 目录，添加如下配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /etc/docker</span><br><span class="line">$ vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span> : [</span><br><span class="line">    <span class="string">&quot;https://ot2k4d59.mirror.aliyuncs.com/&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;graph&quot;</span>: <span class="string">&quot;/data/docker&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>镜像加速器：</strong></p><p>使用加速器可以提升获取 Docker 官方镜像的速度，建议注册阿里云帐号，使用阿里云提供的镜像加速服务，地址：<a href="https://cr.console.aliyun.com/cn-beijing/instances/mirrors%E3%80%82">https://cr.console.aliyun.com/cn-beijing/instances/mirrors。</a></p></blockquote><h3 id="启动docker"><a href="#启动docker" class="headerlink" title="启动docker"></a>启动docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置为开机启动</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> docker  </span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line"><span class="comment"># 启动 docker</span></span><br><span class="line">$ systemctl start docker</span><br></pre></td></tr></table></figure><p>&nbsp;</p><h2 id="部署-EFK"><a href="#部署-EFK" class="headerlink" title="部署 EFK"></a>部署 EFK</h2><h4 id="编写docker-compose启动文件"><a href="#编写docker-compose启动文件" class="headerlink" title="编写docker-compose启动文件"></a>编写docker-compose启动文件</h4><ul><li>创建项目目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /data/project/efk </span><br></pre></td></tr></table></figure><ul><li>编写docker-compose</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  es660:</span><br><span class="line">    image: elasticsearch:6.6.0</span><br><span class="line">    container_name: elasticsearch</span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">    ports:</span><br><span class="line">      - 9200:9200</span><br><span class="line">      - 9300:9300</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/dockerdata/es660/etc/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /data/dockerdata/es660/plugins/x-pack-core:/usr/share/elasticsearch/modules/x-pack-core</span><br><span class="line">      - /data/dockerdata/es660/data/:/usr/share/elasticsearch/data</span><br><span class="line">      - /data/dockerdata/es660/backup:/data/backup</span><br><span class="line">      - /data/dockerdata/es660/logs:/usr/share/elasticsearch/logs</span><br><span class="line">    hostname: es</span><br><span class="line">    restart: always</span><br><span class="line">    network_mode: <span class="string">&quot;bridge&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai<span class="comment"># 更改容器时区为 CST（默认为UTC）</span></span><br><span class="line"></span><br><span class="line">  kibana660:</span><br><span class="line">    image: kibana:6.6.0</span><br><span class="line">    container_name: kibana</span><br><span class="line">    ports:</span><br><span class="line">      - 5601:5601</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/dockerdata/kibana660/etc/kibana.yml:/usr/share/kibana/config/kibana.yml</span><br><span class="line">      - /data/dockerdata/kibana660/plugins:/usr/share/kibana/plugins</span><br><span class="line">      - /data/dockerdata/kibana660/logs:/usr/share/kibana/logs</span><br><span class="line">    hostname: kibana</span><br><span class="line">    restart: always</span><br><span class="line">    network_mode: <span class="string">&quot;bridge&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai<span class="comment"># 更改容器时区为 CST（默认为UTC）</span></span><br><span class="line"></span><br><span class="line">  filebeat660:</span><br><span class="line">    image: elastic/filebeat:6.6.0</span><br><span class="line">    container_name: filebeat</span><br><span class="line">    ports: </span><br><span class="line">      - 5044:5044</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/dockerdata/filebeat660/etc/filebeat.yml:/usr/share/filebeat/filebeat.yml</span><br><span class="line">      - /data/dockerdata/filebeat660/data:/usr/share/filebeat/data</span><br><span class="line">      - /data/dockerdata/filebeat660/logs:/usr/share/filebeat/logs  </span><br><span class="line">      - /data/dockerdata/filebeat660/tmp:/usr/share/filebeat/tmp</span><br><span class="line">      - /data/logs/nginx:/data/logs/nginx<span class="comment"># 把nginx日志目录挂载到容器内部</span></span><br><span class="line">    hostname: filebeat</span><br><span class="line">    restart: always</span><br><span class="line">    network_mode: <span class="string">&quot;bridge&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai<span class="comment"># 更改容器时区为 CST（默认为UTC）</span></span><br></pre></td></tr></table></figure><h4 id="创建EFK相关目录"><a href="#创建EFK相关目录" class="headerlink" title="创建EFK相关目录"></a>创建EFK相关目录</h4><ul><li>创建 ES 所需目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/dockerdata/es660/&#123;etc,plugins,data,logs,backup&#125;</span><br></pre></td></tr></table></figure><ul><li>创建 Kibana 所需目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/dockerdata/kibana660/&#123;etc,plugins,logs&#125;</span><br></pre></td></tr></table></figure><ul><li>创建 Filebeat 所需目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/dockerdata/filebeat660/&#123;etc,data,logs,tmp&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：</strong></p><p>由于目录时挂载进去的，容器内部需要一些读写权限，要进行一些权限配置，否则容器不能正常启动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment"># elasticsearch 目录</span></span><br><span class="line">&gt;chmod 777 /data/dockerdata/es660/&#123;data,logs,backup&#125;</span><br><span class="line">&gt;chmod 644 -R /data/dockerdata/es660/&#123;etc,plugins&#125;/*</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment"># kibana 目录</span></span><br><span class="line">&gt;chmod 777 /data/dockerdata/kibana660/&#123;plugins,logs&#125;</span><br><span class="line">&gt;chmod 644 -R /data/dockerdata/es660/etc/*</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment"># filebeat 目录</span></span><br><span class="line">&gt;chmod 777 /data/dockerdata/filebeat660/&#123;data,logs,tmp&#125;</span><br><span class="line">&gt;chmod 644 -R /data/dockerdata/filebeat660/etc/*</span><br></pre></td></tr></table></figure></blockquote><h4 id="配置EFK所需配置文件"><a href="#配置EFK所需配置文件" class="headerlink" title="配置EFK所需配置文件"></a>配置EFK所需配置文件</h4><ul><li><strong>Elasticsearch所需文件</strong></li></ul><p>配置文件<code>elasticsearch.yml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat&gt;&gt;/data/dockerdata/es660/etc/elasticsearch.yml&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">cluster.name: es</span></span><br><span class="line"><span class="string">node.name: es-01</span></span><br><span class="line"><span class="string">bootstrap.memory_lock: true</span></span><br><span class="line"><span class="string">network.host: 0.0.0.0</span></span><br><span class="line"><span class="string">http.port: 9200</span></span><br><span class="line"><span class="string">discovery.type: single-node     # 启动单节点类型</span></span><br><span class="line"><span class="string">xpack.security.enabled: false    # 关闭x-pack认证</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在本文，我针对ES开启了x-pack插件，所以需要替换原ES的x-pack-core目录文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://dld.wanhebin.com/package/elk/plugins/x-pack-6.6.0/x-pack-core.tar.gz</span><br><span class="line">$ tar xf x-pack-core.tar.gz -C /data/dockerdata/es660/plugins/</span><br></pre></td></tr></table></figure><ul><li><strong>Kibana所需文件</strong></li></ul><p>配置文件<code>kibana.yml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat&gt;&gt;/data/dockerdata/kibana660/etc/kibana.yml&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">server.port: 5601</span></span><br><span class="line"><span class="string">server.host: &quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="string">elasticsearch.hosts: [&quot;http://es660:9200&quot;] # 如果无法正常连接ES，请更换成宿主机docker0网卡的IP</span></span><br><span class="line"><span class="string">kibana.index: &quot;.kibana&quot;</span></span><br><span class="line"><span class="string">logging.dest: /usr/share/kibana/logs/kibana.log</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 连接ES认证配置</span></span><br><span class="line"><span class="string"># elasticsearch.username: &quot;kibana&quot;</span></span><br><span class="line"><span class="string"># elasticsearch.password: &quot;123456&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><strong>Filebeat所需文件</strong></li></ul><p>配置文件<code>filebeat.yml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ cat&gt;&gt;/data/dockerdata/filebeat660/etc/filebeat.yml&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="string">- type: log</span></span><br><span class="line"><span class="string">  enabled: true</span></span><br><span class="line"><span class="string">  paths:</span></span><br><span class="line"><span class="string">    - /data/logs/nginx/nginx_access_json-1.log# json格式的nginx日志文件路径</span></span><br><span class="line"><span class="string">  json.keys_under_root: true</span></span><br><span class="line"><span class="string">  json.overwrite_keys: true</span></span><br><span class="line"><span class="string">  json.message_key: log</span></span><br><span class="line"><span class="string">  tags: [&quot;nginx-log1&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- type: log</span></span><br><span class="line"><span class="string">  enabled: true</span></span><br><span class="line"><span class="string">  paths:</span></span><br><span class="line"><span class="string">    - /data/logs/nginx/nginx_access_json-2.log# json格式的nginx日志文件路径</span></span><br><span class="line"><span class="string">  json.keys_under_root: true</span></span><br><span class="line"><span class="string">  json.overwrite_keys: true</span></span><br><span class="line"><span class="string">  json.message_key: log</span></span><br><span class="line"><span class="string">  tags: [&quot;nginx-log2&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">filebeat.config:</span></span><br><span class="line"><span class="string">  modules:</span></span><br><span class="line"><span class="string">    path: $&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line"><span class="string">    reload.enabled: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">setup.ilm.enabled: false</span></span><br><span class="line"><span class="string">setup.template:</span></span><br><span class="line"><span class="string">  name: &quot;nginx&quot;</span></span><br><span class="line"><span class="string">  pattern: &quot;nginx-*&quot;</span></span><br><span class="line"><span class="string">setup.template.overwrite: true</span></span><br><span class="line"><span class="string">setup.template.enabled: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">output.elasticsearch:</span></span><br><span class="line"><span class="string">  hosts: [&quot;es660:9200&quot;]# 如果无法正常连接ES，请更换成宿主机docker0网卡的IP</span></span><br><span class="line"><span class="string">  indices:</span></span><br><span class="line"><span class="string">    - index: &quot;nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line"><span class="string">      when.contains:</span></span><br><span class="line"><span class="string">        tags: &quot;nginx-log1&quot;</span></span><br><span class="line"><span class="string">    - index: &quot;nginx-error-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line"><span class="string">      when.contains:</span></span><br><span class="line"><span class="string">        tags: &quot;nginx-log2&quot;</span></span><br><span class="line"><span class="string">  # ES连接认证</span></span><br><span class="line"><span class="string">  # username: &#x27;elastic&#x27;  </span></span><br><span class="line"><span class="string">  # password: &#x27;changeme&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">setup.template.overwrite: false</span></span><br><span class="line"><span class="string">setup.template.json.enabled: true</span></span><br><span class="line"><span class="string">setup.template.enabled: false</span></span><br><span class="line"><span class="string">setup.ilm.enabled: false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&nbsp;</p><h2 id="破解-Elasticsearch-的x-pack插件"><a href="#破解-Elasticsearch-的x-pack插件" class="headerlink" title="破解 Elasticsearch 的x-pack插件"></a>破解 Elasticsearch 的x-pack插件</h2><p>在上面已经把x-pacK-core插件目录替换成了破解包，接下来只需要进行激活步鄹。</p><p>详细步鄹参考 <a href="https://www.wanhebin.com/devops/elk/elasticsearch/983.html">Elasticsearch 6.6.0 x-pack 破解</a> 进行x-pack激活。</p><ul><li><strong>启动es容器</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data/project/efk</span><br><span class="line">$ docker-compose start es660</span><br></pre></td></tr></table></figure><ul><li><strong>导入liences</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://dld.wanhebin.com/package/elk/plugins/x-pack-6.6.0/license.json</span><br><span class="line">$ curl -XPUT -H <span class="string">&quot;Content-Type: application/json&quot;</span> <span class="string">&#x27;http://127.0.0.1:9200/_xpack/license&#x27;</span> -d @license.json</span><br></pre></td></tr></table></figure><ul><li><strong>查看 license 授权</strong></li></ul><p><img src="http://pic-cdn.wanhebin.com/2020/12/07/0147ef657804c.png" alt="efk-04.png"></p><p>&nbsp;</p><h2 id="EFK-开启-X-PACK-认证"><a href="#EFK-开启-X-PACK-认证" class="headerlink" title="EFK 开启 X-PACK 认证"></a>EFK 开启 X-PACK 认证</h2><h3 id="ES开启x-pack认证"><a href="#ES开启x-pack认证" class="headerlink" title="ES开启x-pack认证"></a>ES开启x-pack认证</h3><ul><li><strong>修改配置文件<code>/data/dockerdata/es660/etc/elasticsearch.yml</code></strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed -ir <span class="string">&#x27;s@xpack.security.enabled: false@xpack.security.enabled: true@g&#x27;</span> /data/dockerdata/es660/etc/elasticsearch.yml</span><br></pre></td></tr></table></figure><ul><li><strong>重启es容器</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data/project/efk</span><br><span class="line">$ docker-compose restart es660</span><br></pre></td></tr></table></figure><ul><li><strong>进入容器，设置ES密码</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入es容器内部</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it elasticsearch bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器内，进入es目录，生成密码</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/share/elasticsearch</span><br><span class="line">$ ./bin/elasticsearch-setup-passwords auto  </span><br></pre></td></tr></table></figure><h3 id="Kibana-开启认证"><a href="#Kibana-开启认证" class="headerlink" title="Kibana 开启认证"></a>Kibana 开启认证</h3><p>开启用户认证，让kibana可以正常访问es。</p><ul><li><strong>修改<code>kibana.yml</code>配置文件</strong></li></ul><p>在之前写kibana配置文件时，就已经把认证配置加上了，现在取消注释。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sed -ir <span class="string">&#x27;s@# elasticsearch.username: &quot;kibana&quot;@elasticsearch.username: &quot;kibana&quot;@g&#x27;</span> /data/dockerdata/kibana660/etc/kibana.yml</span><br><span class="line"></span><br><span class="line">$ sed -ir <span class="string">&#x27;s@# elasticsearch.password: &quot;123456&quot;@elasticsearch.password: &quot;123456&quot;@g&#x27;</span> /data/dockerdata/kibana660/etc/kibana.yml</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：</strong>这里的用户密码，填写刚才es里生成的密码</p></blockquote><ul><li><strong>启动kibana容器</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data/project/efk</span><br><span class="line">$ docker-compose restart kibana660</span><br></pre></td></tr></table></figure><h3 id="Filebeat-开启认证"><a href="#Filebeat-开启认证" class="headerlink" title="Filebeat 开启认证"></a>Filebeat 开启认证</h3><p>开启用户认证，让filebeat可以正常访问es，使其可以向es传输数据。</p><ul><li><strong>修改<code>kibana.yml</code>配置文件</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sed -ir <span class="string">&#x27;s@# username: &#x27;</span>elastic<span class="string">&#x27;@username: &#x27;</span>elastic<span class="string">&#x27;@g&#x27;</span> /data/dockerdata/filebeat660/etc/filebeat.yml</span><br><span class="line"></span><br><span class="line">$ sed -ir <span class="string">&#x27;s@# password: &#x27;</span>changeme<span class="string">&#x27;@password: &#x27;</span>changeme<span class="string">&#x27;@g&#x27;</span> /data/dockerdata/filebeat660/etc/filebeat.yml</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：</strong>这里的用户密码，填写刚才es里生成的密码</p></blockquote><ul><li><strong>启动filebeat容器</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data/project/efk</span><br><span class="line">$ docker-compose restart filebeat660</span><br></pre></td></tr></table></figure><h3 id="查看EFK容器状态"><a href="#查看EFK容器状态" class="headerlink" title="查看EFK容器状态"></a>查看EFK容器状态</h3><p>所有容器的 STATUS 都为 UP 说明容器正常启动运行。</p><p><img src="http://pic-cdn.wanhebin.com/2020/12/07/2fb0742a742c4.png" alt="efk-01.png"></p><p>如果有容器不处于 UP 状态，请检查相关容器日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs -f 容器名</span><br></pre></td></tr></table></figure><p>&nbsp;</p><h2 id="登录-Kibana-界面"><a href="#登录-Kibana-界面" class="headerlink" title="登录 Kibana 界面"></a>登录 Kibana 界面</h2><p>使用<code>elastic</code>账户进行登录，地址：<a href="http://ip:5601/">http://IP:5601</a></p><p><img src="http://pic-cdn.wanhebin.com/2020/12/07/9b699f90773ed.png" alt="efk-02.png"><img src="http://pic-cdn.wanhebin.com/2020/12/07/d59c9726ffa60.png" alt="efk-03.png"></p>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 6.6.0 X-PACK 破解</title>
      <link href="posts/elasticsearch-6.6.0-x-pack-crack/"/>
      <url>posts/elasticsearch-6.6.0-x-pack-crack/</url>
      
        <content type="html"><![CDATA[<h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><p><strong>软件包版本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-6.6.0.rpm</span><br><span class="line">kibana-6.6.0-x86_64.rpm</span><br><span class="line">logstash-6.6.0.rpm</span><br></pre></td></tr></table></figure><p><strong>在做下列操作前，建议先停止Elasticsearch、Kibana</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop elasticsearch kibana</span><br></pre></td></tr></table></figure><p>如果是相同版本，可直接使用已破解好的相关 x-pack-6.6.0 文件：<a href="http://dld.wanhebin.com/package/elk/plugins/x-pack-6.6.0.zip">下载地址</a></p><p>&nbsp;</p><h3 id="反编译-x-pack-core-6-6-0-jar"><a href="#反编译-x-pack-core-6-6-0-jar" class="headerlink" title="反编译 x-pack-core-6.6.0.jar"></a>反编译 x-pack-core-6.6.0.jar</h3><p>下载Luyten：<a href="https://github.com/deathmarine/Luyten/release">https://github.com/deathmarine/Luyten/release</a></p><p>从ES服务器上把<code>x-pack-core-6.6.0.jar</code> 下载到PC，打开Luyten软件，并把<code>x-pack-core-6.6.0.jar</code>包拖入。</p><blockquote><p>rpm包安装的elasticsearch插件路径：<code>/usr/share/elasticsearch/modules/x-pack-core/x-pack-core-6.6.0.jar</code></p></blockquote><p>找到 <code>org.elasticsearch.license.LicenseVerifier</code>、<code>org.elasticsearch.xpack.core.XPackBuild</code>这两个文件。</p><p><img src="https://pic-cdn.wanhebin.com/2020/11/18/f0292119e3f0d.png" alt="x-pack-01.png"></p><p><img src="https://pic-cdn.wanhebin.com/2020/11/18/5b90efa381229.png" alt="x-pack-02.png"></p><p>选择文件后，使用 Luyten 的 Save As 提取出文件。</p><p>&nbsp;</p><h3 id="修改文件"><a href="#修改文件" class="headerlink" title="修改文件"></a>修改文件</h3><h4 id="1、修改LicenseVerifier-java"><a href="#1、修改LicenseVerifier-java" class="headerlink" title="1、修改LicenseVerifier.java"></a>1、修改<code>LicenseVerifier.java</code></h4><blockquote><p>LicenseVerifier 中有两个静态方法，这就是验证授权文件是否有效的方法，我们把它修改为全部返回true。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.elasticsearch.license;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.bytes.*;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.core.internal.io.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LicenseVerifier</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">verifyLicense</span><span class="params">(<span class="keyword">final</span> License license, <span class="keyword">final</span> <span class="keyword">byte</span>[] publicKeyData)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">verifyLicense</span><span class="params">(<span class="keyword">final</span> License license)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、修改XPackBuild-java"><a href="#2、修改XPackBuild-java" class="headerlink" title="2、修改XPackBuild.java"></a>2、修改<code>XPackBuild.java</code></h4><blockquote><p>XPackBuild 中最后一个静态代码块中 try的部分全部删除，这部分会验证jar包是否被修改。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.elasticsearch.xpack.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XPackBuild</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> XPackBuild CURRENT;</span><br><span class="line">    <span class="keyword">private</span> String shortHash;</span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@SuppressForbidden(reason = &quot;looks up path of xpack.jar directly&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Path <span class="title">getElasticsearchCodebase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> URL url = XPackBuild.class.getProtectionDomain().getCodeSource().getLocation();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> PathUtils.get(url.toURI());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (URISyntaxException bogus) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(bogus);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    XPackBuild(<span class="keyword">final</span> String shortHash, <span class="keyword">final</span> String date) &#123;</span><br><span class="line">        <span class="keyword">this</span>.shortHash = shortHash;</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">shortHash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.shortHash;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">date</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.date;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Path path = getElasticsearchCodebase();</span><br><span class="line">        String shortHash = <span class="keyword">null</span>;</span><br><span class="line">        String date = <span class="keyword">null</span>;</span><br><span class="line">        Label_0109: &#123;</span><br><span class="line">            shortHash = <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">            date = <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CURRENT = <span class="keyword">new</span> XPackBuild(shortHash, date);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&nbsp;</p><h3 id="编译修改后的java文件"><a href="#编译修改后的java文件" class="headerlink" title="编译修改后的java文件"></a>编译修改后的java文件</h3><p>先将修改后的文件上传到ES服务器上，再进行编译。</p><ul><li>编译生成新的 class 文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javac -cp <span class="string">&quot;/usr/share/elasticsearch/modules/x-pack-core/x-pack-core-6.6.0.jar:/usr/share/elasticsearch/lib/*&quot;</span> LicenseVerifier.java </span><br><span class="line"></span><br><span class="line">javac -cp <span class="string">&quot;/usr/share/elasticsearch/modules/x-pack-core/x-pack-core-6.6.0.jar:/usr/share/elasticsearch/lib/*&quot;</span> XPackBuild.java </span><br></pre></td></tr></table></figure><ul><li>覆盖原class文件</li></ul><p>复制并解压 x-pack-core-6.6.0.jar 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/x-pack-core-6.6.0</span><br><span class="line">cp /usr/share/elasticsearch/modules/x-pack-core/x-pack-core-6.6.0.jar /opt/</span><br><span class="line">unzip xf x-pack-core-6.6.0.jar -d x-pack-core-6.6.0/</span><br><span class="line"><span class="built_in">cd</span> /opt/x-pack-core-6.6.0/</span><br></pre></td></tr></table></figure><p>把<code>LicenseVerifier.class</code>、<code>XPackBuild.class</code>覆盖原文件</p><blockquote><p>LicenseVerifier.class 路径： <code>org/elasticsearch/license/LicenseVerifier.class</code></p><p>XPackBuild.class 路径： <code>org/elasticsearch/xpack/core/XPackBuild.class</code></p></blockquote><p>&nbsp;</p><h3 id="重新打包并替换-x-pack-core-6-6-0-jar"><a href="#重新打包并替换-x-pack-core-6-6-0-jar" class="headerlink" title="重新打包并替换 x-pack-core-6.6.0.jar"></a>重新打包并替换 x-pack-core-6.6.0.jar</h3><ul><li>打包<code>x-pack-core-6.6.0</code>为新的 x-pack-core-6.6.0.jar</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/x-pack-core-6.6.0/</span><br><span class="line">jar cvf /root/x-pack-core-6.6.0.jar *</span><br></pre></td></tr></table></figure><ul><li>备份原来的 x-pack-core-6.6.0.jar，并将新的 x-pack-core-6.6.0.jar 覆盖原文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/elasticsearch/modules/x-pack-core/x-pack-core-6.6.0.jar&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line">\cp /opt/x-pack-core-6.6.0/x-pack-core-6.6.0.jar /usr/share/elasticsearch/modules/x-pack-core/x-pack-core-6.6.0.jar</span><br></pre></td></tr></table></figure><p>&nbsp;</p><h3 id="授权文件导入"><a href="#授权文件导入" class="headerlink" title="授权文件导入"></a>授权文件导入</h3><h4 id="1、禁用-x-pack-security"><a href="#1、禁用-x-pack-security" class="headerlink" title="1、禁用 x-pack security"></a>1、禁用 <code>x-pack security</code></h4><p>先把禁用<code>x-pack security</code>，否则不能正常导入 license 文件 </p><blockquote><p><code>vim /etc/elasticsearch/elasticsearch.yml</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>重启elasticsearch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart elasticsearch.service</span><br></pre></td></tr></table></figure><h4 id="2、修改授权文件"><a href="#2、修改授权文件" class="headerlink" title="2、修改授权文件"></a>2、修改授权文件</h4><blockquote><p>去官网申请basic授权文件：<a href="https://license.elastic.co/registration">https://license.elastic.co/registration</a></p><p>根据邮箱里的链接下载授权文件，更改名为 license.json</p></blockquote><p>修改 license.json 信息</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;license&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;uid&quot;</span>:<span class="string">&quot;654c015f-2dba-4412-b6dc-38939b36b2de&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;platinum&quot;</span>,#修改为白金授权</span><br><span class="line">        <span class="attr">&quot;issue_date_in_millis&quot;</span>:<span class="number">1605571200000</span>,</span><br><span class="line">        <span class="attr">&quot;expiry_date_in_millis&quot;</span>:<span class="number">4070793600000</span>,#2098年过期</span><br><span class="line">        <span class="attr">&quot;max_nodes&quot;</span>:<span class="number">999</span>,#集群最大节点数</span><br><span class="line">        <span class="attr">&quot;issued_to&quot;</span>:<span class="string">&quot;HEBIN (China)&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;issuer&quot;</span>:<span class="string">&quot;Web Form&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;signature&quot;</span>:<span class="string">&quot;AAAA........zDD1U&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;start_date_in_millis&quot;</span>:<span class="number">1605571200000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、导入-license"><a href="#3、导入-license" class="headerlink" title="3、导入 license"></a>3、导入 license</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT -H <span class="string">&quot;Content-Type: application/json&quot;</span> <span class="string">&#x27;http://127.0.0.1:9200/_xpack/license&#x27;</span> -d @license.json</span><br></pre></td></tr></table></figure><ul><li>查看 license 授权</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://127.0.0.1:9200/_license</span><br></pre></td></tr></table></figure><p><img src="https://pic-cdn.wanhebin.com/2020/11/18/dee1d2e2453d7.png" alt="x-pack-03.png"></p><p>&nbsp;</p><h3 id="ES开启x-pack认证"><a href="#ES开启x-pack认证" class="headerlink" title="ES开启x-pack认证"></a>ES开启x-pack认证</h3><ul><li>修改配置文件<code>/etc/elasticsearch/elasticsearch.yml</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xpack.security.enabled: <span class="literal">true</span></span><br><span class="line">xpack.security.transport.ssl.enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure><ul><li>重启elasticsearch</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart elasticsearch.service</span><br></pre></td></tr></table></figure><p>&nbsp;</p><h3 id="设置ES密码"><a href="#设置ES密码" class="headerlink" title="设置ES密码"></a>设置ES密码</h3><ul><li><strong>生成自定义密码</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive</span><br></pre></td></tr></table></figure><ul><li><strong>生成随机密码</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto</span><br></pre></td></tr></table></figure><p>&nbsp;</p><h3 id="Kibana开启x-pack认证"><a href="#Kibana开启x-pack认证" class="headerlink" title="Kibana开启x-pack认证"></a>Kibana开启x-pack认证</h3><ul><li>修改配置文件<code>vim /etc/kibana/kibana.yml</code></li></ul><p>密码填写上一步生成的elastic用户密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch.username: <span class="string">&quot;elastic&quot;</span></span><br><span class="line">elasticsearch.password: <span class="string">&quot;changeme&quot;</span></span><br></pre></td></tr></table></figure><ul><li>重启kibana</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kibana.service</span><br></pre></td></tr></table></figure><ul><li>访问kibana页面，验证x-pack</li></ul><p><img src="https://pic-cdn.wanhebin.com/2020/11/18/20c79a8ed2504.png" alt="x-pack-04.png"></p><p>&nbsp;</p><h3 id="Logstash开启x-pack认证"><a href="#Logstash开启x-pack认证" class="headerlink" title="Logstash开启x-pack认证"></a>Logstash开启x-pack认证</h3><ul><li>在<code>logstash.yml</code>中配置验证</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xpack.monitoring.enabled: <span class="literal">true</span></span><br><span class="line">xpack.monitoring.elasticsearch.username: logstash_system</span><br><span class="line">xpack.monitoring.elasticsearch.password: xxxxxxx<span class="comment">#填写对应用户密码</span></span><br></pre></td></tr></table></figure><ul><li>在<code>/etc/logstash/conf.d/test.conf</code>配置文件的 output 模块中配置验证验证</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">elasticsearch &#123;</span><br><span class="line">hosts =&gt; [<span class="string">&quot;127.0.0.1:9200&quot;</span>]</span><br><span class="line">index =&gt; <span class="string">&quot;system-syslog-toes-%&#123;+YYYY.MM&#125;&quot;</span></span><br><span class="line">user =&gt; <span class="string">&quot;logstash_system&quot;</span><span class="comment">#填写用户名</span></span><br><span class="line">password =&gt; <span class="string">&quot;xxxxx&quot;</span><span class="comment">#填写对应用户密码</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>重启logstash</li></ul>]]></content>
      
      
      <categories>
          
          <category> Elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ZABBIX 4.4安装部署</title>
      <link href="posts/zabbix-installation-and-deployment/"/>
      <url>posts/zabbix-installation-and-deployment/</url>
      
        <content type="html"><![CDATA[<h3 id="安装zabbix"><a href="#安装zabbix" class="headerlink" title="安装zabbix"></a>安装zabbix</h3><ul><li><strong>配置Zabbix的yum源仓库</strong></li></ul><p>安装一个Zabbix官方源仓库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh https://repo.zabbix.com/zabbix/4.4/rhel/7/x86_64/zabbix-release-4.4-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure><p>改用官方源为阿里云镜像源：</p><p>由于官方源是国外的镜像仓库，速度非常慢，改用阿里云的镜像仓库会非常快。只需在官方源的repo文件中修改URL即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s@http://repo.zabbix.com@https://mirrors.aliyun.com/zabbix@g&#x27; /etc/yum.repos.d/zabbix.repo</span><br></pre></td></tr></table></figure><ul><li><strong>安装zabbix</strong></li></ul><p>安装Zabbix 服务端，web前端，客户端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zabbix-server-mysql zabbix-web-mysql zabbix-agent</span><br></pre></td></tr></table></figure><ul><li><strong>安装Zabbix前端软件包。</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zabbix-web-mysql zabbix-nginx-conf</span><br></pre></td></tr></table></figure><h3 id="安装配置数据库"><a href="#安装配置数据库" class="headerlink" title="安装配置数据库"></a>安装配置数据库</h3><p>数据库这里使用mysql和mariadb都可以，此处以mariadb为例。</p><ul><li>安装mariadb</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mariadb-server mariadb</span><br></pre></td></tr></table></figure><ul><li>启动mariadb</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br><span class="line">systemctl restart mariadb</span><br></pre></td></tr></table></figure><ul><li>配置数据库</li></ul><p>创建数据库，数据库用户，并授权</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; create user zabbix@<span class="string">&#x27;127.0.0.1&#x27;</span> identified by <span class="string">&#x27;zabbix&#x27;</span>;</span><br><span class="line">mysql&gt; grant all privileges on zabbix.* to zabbix@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br></pre></td></tr></table></figure><p>导入zabbix的初始数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -pzabbix zabbix</span><br></pre></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><ul><li>配置zabbix服务端<code>/etc/zabbix/zabbix_server.conf</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-server ~]<span class="comment"># vim /etc/zabbix/zabbix_server.conf</span></span><br><span class="line">DBHost=127.0.0.1</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br></pre></td></tr></table></figure><ul><li>编辑文件/etc/php-fpm.d/zabbix.conf，取消注释并设置正确的时区。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">把     ; php_value[date.timezone] = Europe/Riga</span><br><span class="line">修改为  php_value[date.timezone] = Asia/Shanghai</span><br></pre></td></tr></table></figure><ul><li>启动服务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart zabbix-server zabbix-agent nginx php-fpm</span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-server zabbix-agent nginx php-fpm</span><br></pre></td></tr></table></figure><ul><li>检查端口</li></ul><p>zabbix服务端端口为10051，客户端端口为10050</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-server ~]<span class="comment"># netstat -lnt | grep -E &#x27;10050|10051&#x27;</span></span><br><span class="line">tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN     </span><br><span class="line">tcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN     </span><br><span class="line">tcp6       0      0 :::10050                :::*                    LISTEN     </span><br><span class="line">tcp6       0      0 :::10051                :::*                    LISTEN  </span><br></pre></td></tr></table></figure><h3 id="配置Zabbix前端"><a href="#配置Zabbix前端" class="headerlink" title="配置Zabbix前端"></a>配置Zabbix前端</h3><p>前端Web界面地址：<a href="http://10.0.0.210/">http://10.0.0.210</a></p><ul><li><strong>安装界面配置</strong></li></ul><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/0827747ace8ab.png" alt="zabbix_install-1.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/dd2b212b2eb17.png" alt="zabbix_install-2.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/f64d51eb86296.png" alt="zabbix_install-3.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/9a7ec649a975a.png" alt="zabbix_install-4.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/38f8de7c0f22f.png" alt="zabbix_install-5.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/ba5eaa4459125.png" alt="zabbix_install-6.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/cdb9134b36f72.png" alt="zabbix_install-7.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/bacb67b035e86.png" alt="zabbix_install-8.png"></p><ul><li><strong>如果不习惯英文界面，可以修改为中文界面</strong></li></ul><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/ed3c41c2ebb58.png" alt="zabbix_install-9.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/8465d70999d5c.png" alt="zabbix_install-10.png"></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/e7b35fdf44cb5.png" alt="zabbix_install-11.png"></p><p>到这里，Zabbix4.4就安装完成了。</p><h3 id="解决中文乱码问题"><a href="#解决中文乱码问题" class="headerlink" title="解决中文乱码问题"></a>解决中文乱码问题</h3><p>在zabbix设置中文显示后，监控图形的一些中文会显示乱码，这是由于linux系统无法识别造成的。</p><p>可以拷贝一份中文字体到zabbix服务的字符集目录下。</p><ul><li>在window 10系统<code>C:\Windows\Fonts</code>下随便选一个中文字体上传到zabbix-server的<code>/usr/share/zabbix/assets/fonts/</code>目录下（比如这里选用微软雅黑）</li></ul><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/3e51a22d4feba.png" alt="zabbix_install-12.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#备份原文件</span></span><br><span class="line">mv /usr/share/zabbix/assets/fonts/graphfont.ttf&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重命名中文字字符集文件</span></span><br><span class="line">mv msyh.ttc graphfont.ttf</span><br></pre></td></tr></table></figure><ul><li>刷新zabbix页面，对比修改前后效果</li></ul><p><strong>修改前</strong></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/bf3ce503ca864.png" alt="zabbix_install-13.png"></p><p><strong>修改后</strong></p><p><img src="https://pic-cdn.wanhebin.com/2021/05/17/5b2585f67a36d.png" alt="zabbix_install-14.png"></p>]]></content>
      
      
      <categories>
          
          <category> ZABBIX </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ZABBIX </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
